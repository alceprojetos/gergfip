* A T E N C A O
*
* O TETO DO INSS DESTE MES NO CASO DO PESSOAL
* DO FINANCEIRO (ZE HUGO) O VALOR DO TETO E DE R$ 608,44
  WTETO = 608.44
*
SET TALK OFF
SET ECHO OFF
SET STEP OFF
SET DATE BRIT
SET CENT ON
*
CLEAR
*
WMESANO:= '  /    '
*
@ 24,65 GET WMESANO PICT '99/9999' WHEN MENS('Entre com o MES/ANO da GEFIP. <ESC> Retorna: ')
READ
*
IF LASTKEY() = 27
   QUIT
ENDIF
*
WMES:= SUBS(WMESANO,1,2)
WMESEXT:= SUBS([JANFEVMARABRMAIJUNJULAGOSETOUTNOVDEZ],VAL(WMES) * 3 - 2,3)
WANO:= SUBS(WMESANO,6,2)
WANOEXT:= SUBS(WMESANO,4,4)
WINSS:= [INS] + WMESEXT + WANO
WGFIP:= [GFIP] + WMES + WANO
WMESANO:= WMES + WANO
WAMES:= WMESEXT + WANO
WHUGO:= [ZH] + WMES + WANOEXT
WHUGO1:= WMES + WANOEXT + [.TXT]
WHUGO2:= WHUGO + [.TXT]
*
RENAME WHUGO1 TO WHUGO2
*
WSTRUINS:= {{'STATUS','C',10,0},{'FLAGSIT','C',1,0},{'FF','C',2,0},{'MATR','C',6,0},;
            {'MATRICULA','C',11,0},{'NOME','C',70,0},{'PISPASEP','C',11,0},;
            {'DATADM','C',8,0},{'DATNASC','C',8,0},{'&WAMES','N',13,2},;
            {'REMSEM13','C',16,0},{'DESCONINSS','C',16,0},{'DEZ13','N',13,2},{'REMCOM13','C',16,0},;
            {'LOTACAO','C',7,0},{'DESCSALA','C',70,0},{'MVINC','C',1,0},;
            {'EXONERADO','C',1,0},{'DATDEMI','C',8,0},{'FALECIDO','C',1,0},;
            {'DATFALEC','C',8,0},{'TOTSALFAM','N',13,2},{'TOTSALMAT','N',13,2},{'FORA','N',13,2}}
**WSTRUZE:= {{'NOME','C',50,0},{'PIS','C',13,0},{'NIT','C',14,0},;
**           {'VALOR','C',10,0},{'PISPASEP','C',11,0},{'&WAMES','N',13,2},;
**           {'REMSEM13','C',16,0},{'DESCONINSS','C',16,0},{'MVINC','C',1,0}}
WSTRUZE:= {{'NOME','C',50,0},{'PISPASEP','C',11,0},{'LIXO','C',14,0},;
           {'VALOR','C',12,0},{'COMPENSACA','C',10,0},{'&WAMES','N',13,2},;
           {'REMSEM13','C',16,0},{'DESCONINSS','C',16,0},{'MVINC','C',1,0}}
WARQINS:= [INS] + WAMES
WARQZE:= [ZEHUGO]
*
DBCREATE('&WARQINS',WSTRUINS)
DBCREATE('&WARQZE',WSTRUZE)
*
WVERARQ:= WGFIP + '.DBF'
*
IF !FILE(WVERARQ)
   @ 10,27 SAY [ARQUIVO ] + WVERARQ + [ FALTANDO!]
   *
   WAIT ''
   *
   QUIT
ENDIF
*
WVERARQ1:= WHUGO + '.DBF'
*
IF !FILE(WVERARQ)
   @ 10,27 SAY [ARQUIVO ] + WVERARQ1 + [ FALTANDO!]
   *
   WAIT ''
   *
   QUIT
ENDIF
*
SELE 1
USE &WINSS
ZAP
*
APPE FROM &WGFIP FOR ISENTO <> [S] .AND. ISENTO <> [ ]
*
REPL ALL MATRICULA WITH [00000] + MATR
REPL ALL STATUS WITH [VAI]
REPL ALL FLAGSIT WITH [1]
*
INDE ON FF + MATR TO &WINSS
*
SELE 2
USE &WGFIP
INDE ON FF + MATR TO &WGFIP
*
SELE 1
SET RELA TO FF + MATR INTO &WGFIP
*
REPL ALL PISPASEP WITH &WGFIP->PASEP
REPL ALL DATADM WITH SUBS(DTOC(&WGFIP->DTENT),1,2) + SUBS(DTOC(&WGFIP->DTENT),4,2) + SUBS(DTOC(&WGFIP->DTENT),7,4)
REPL ALL DATNASC WITH SUBS(DTOC(&WGFIP->DTNASC),1,2) + SUBS(DTOC(&WGFIP->DTNASC),4,2) + SUBS(DTOC(&WGFIP->DTNASC),7,4)
REPL ALL LOTACAO WITH &WGFIP->CODLOTA
REPL ALL DESCSALA WITH &WGFIP->LOTACAO
REPL ALL &WAMES WITH IIF(AT([,],&WGFIP->BASE)>0,VAL(SUBS(&WGFIP->BASE,1,AT([,],&WGFIP->BASE) - 1) +;
                     [.] + SUBS(&WGFIP->BASE,AT([,],&WGFIP->BASE) + 1)),VAL(&WGFIP->BASE))
REPL ALL REMSEM13 WITH TRIM(LTRIM(STR(&WMESANO * 100,15)))
REPL ALL STATUS WITH [PENDENTE] FOR PISPASEP = [ ] .OR.;
                                    DATADM = [ ] .OR. DATNASC = [ ] .OR. LEN(TRIM(LTRIM(PISPASEP))) < 11
REPL ALL TOTSALFAM WITH &WGFIP->VLRSALFAM 
REPL ALL TOTSALMAT WITH &WGFIP->VLRSALMAT
REPL ALL MVINC WITH &WGFIP->MVINC
REPL ALL EXONERADO WITH &WGFIP->EXONERADO
REPL ALL DESCONINSS WITH TRIM(LTRIM(STR(&WGFIP->INSSANT * 100,15)))
*
CLOSE DATA
*
USE ZEHUGO
ZAP
*
APPE FROM &WHUGO SDF
*
* ESSES DOIS CAMPOS TEM QUE SER ATUALIZADOS PRIMEIRO
REPL ALL MVINC WITH [S] FOR LEN(TRIM(LTRIM(COMPENSACA))) <> 0

**REPL ALL DESCONINSS WITH IIF(AT([,],PISPASEP)>0,SUBS(PISPASEP,1,AT([,],PISPASEP) - 1) +;
**                         [.] + SUBS(PISPASEP,AT([,],PISPASEP) + 1),PISPASEP)
*
REPL ALL MVINC WITH [N] FOR MVINC <> [S]
**REPL ALL PISPASEP WITH PIS FOR PIS <> [ ]
**REPL ALL PISPASEP WITH NIT FOR NIT <> [ ]
REPL ALL &WAMES WITH VAL(VALOR)
REPL ALL REMSEM13 WITH TRIM(LTRIM(STR(&WAMES * 100,15)))
REPL ALL DESCONINSS WITH TRIM(LTRIM(STR(VAL(VALOR) * 0.11,15,2))) FOR LEN(TRIM(LTRIM(DESCONINSS))) = 0
REPL ALL DESCONINSS WITH TRIM(LTRIM(STR(WTETO,15,2))) FOR VAL(DESCONINSS) > WTETO
REPL ALL DESCONINSS WITH TRIM(LTRIM(STR(VAL(DESCONINSS) * 100,15)))
REPL ALL DESCONINSS WITH TRIM(LTRIM(STR(VAL(COMPENSACA) * 100,15))) FOR LEN(TRIM(LTRIM(COMPENSACA))) <> 0
*
USE
*
SELE 1
USE &WINSS
INDE ON PISPASEP TO &WINSS
*
SELE 2
USE ZEHUGO
INDE ON PISPASEP TO ZEHUGO
SET RELA TO PISPASEP INTO &WINSS
*
REPL ALL MVINC WITH [S] FOR PISPASEP = &WINSS->PISPASEP .AND. LEN(TRIM(LTRIM(PISPASEP)))<>0
*
CLOSE DATA
*
SELE 1
USE ZEHUGO
INDE ON PISPASEP TO ZEHUGO
*
SELE 2
USE &WGFIP
INDE ON PASEP TO &WGFIP
SET RELA TO PASEP INTO ZEHUGO
*
REPL ALL MVINC WITH [S] FOR PASEP = ZEHUGO->PISPASEP .AND. LEN(TRIM(LTRIM(PASEP)))<>0
*
CLOSE DATA
*
SELE 1
USE ZEHUGO
INDE ON PISPASEP TO ZEHUGO
*
SELE 2
USE &WINSS
INDE ON PISPASEP TO &WINSS
SET RELA TO PISPASEP INTO ZEHUGO
*
REPL ALL MVINC WITH [S] FOR PISPASEP = ZEHUGO->PISPASEP .AND. ZEHUGO->MVINC = [S] .AND. LEN(TRIM(LTRIM(PISPASEP)))<>0
*
SELE 1
USE
*
SELE 2
APPE FROM ZEHUGO
REPL ALL REMSEM13 WITH TRIM(LTRIM(STR(&WAMES * 100,15)))
REPL ALL STATUS WITH [VAI] FOR MATR = [ ]
REPL ALL FLAGSIT WITH [1] FOR MATR = [ ]
REPL ALL MVINC WITH [N] FOR MVINC = [ ]
REPL ALL STATUS WITH [PENDENTE] FOR PISPASEP = [ ] .OR. LEN(TRIM(LTRIM(PISPASEP))) < 11
*
CLOSE DATA
*
CLEAR
CLEAR ALL
*
QUIT

//////////////////////////////////////
func mens(wstr,wpara,wlin,wcor,waviso)
//////////////////////////////////////
  local cor:= if(wcor = nil.or.!iscolor(),setcolor('w+/b'),setcolor(wcor)),i,j,k
  *
  setcursor(0)
  *
  if waviso # nil; tone(450,7); endif
  *
  if wpara = nil; wpara:= .f.; endif
  *
  if wlin = nil; wlin:= 24; endif
  *
  K:= setcolor('n/n'); @ wlin,0; setcolor(k)
  *
  for i:= 1 to len(wstr) / 2
      @ wlin,40 - i say subs(wstr,1,i)
      @ wlin,40 say subs(wstr,len(wstr) - i + 1,i)
      *
      j:= 0; do while j++ # 15; enddo
  next
  *
  @ wlin,0; @ wlin,(80 - len(wstr)) / 2 say wstr
  *
  if wpara; inkey(0); endif
  *
  setcolor(cor); setcursor(1)
  *
  return(.t.)
